#!/bin/bash
set -euo pipefail

# =============================
# Enhanced Multi-VM Manager (Ryzen 9 Fixed)
# =============================

VM_DIR="$HOME/vms"
mkdir -p "$VM_DIR"

declare -A OS_OPTIONS=(
    ["Ubuntu 22.04"]="Ubuntu|jammy|https://cloud-images.ubuntu.com/jammy/current/jammy-server-cloudimg-amd64.img|ubuntu-vps|admin|password123"
    ["Debian 12"]="Debian|bookworm|https://cloud.debian.org/images/cloud/bookworm/latest/debian-12-generic-amd64.qcow2|debian-vps|admin|password123"
)

# Function to start a VM (Ryzen 9 Emulation Fix)
start_vm() {
    local vm_name=$1
    
    if load_vm_config "$vm_name"; then
        echo -e "\033[1;34m[INFO]\033[0m Starting VM: $vm_name as Ryzen 9..."
        
        # Check if KVM is available, if not, use TCG
        local accel="kvm"
        if [ ! -e /dev/kvm ]; then
            accel="tcg"
            echo -e "\033[1;33m[WARN]\033[0m KVM not found, using TCG acceleration (slower)"
        fi
        
        # Modified QEMU Command for Ryzen 9 Spoofing
        qemu-system-x86_64 \
            -accel $accel \
            -m "$MEMORY" \
            -smp "$CPUS",sockets=1,cores="$CPUS",threads=1 \
            -cpu EPYC,vendor=AuthenticAMD,model-id="AMD Ryzen 9 5950X 16-Core Processor",+topoext,+invtsc,+amd-ssbd,+virt-ssbd \
            -drive "file=$IMG_FILE,format=qcow2,if=virtio" \
            -drive "file=$SEED_FILE,format=raw,if=virtio" \
            -device virtio-net-pci,netdev=n0 \
            -netdev "user,id=n0,hostfwd=tcp::$SSH_PORT-:22" \
            -nographic -serial mon:stdio \
            -boot order=c
            
        echo -e "\033[1;34m[INFO]\033[0m VM $vm_name has been shut down"
    fi
}

# --- আগের বাকি সব ফাংশন (create, save, load) ঠিক থাকবে ---
# (আপনার স্ক্রিপ্টের বাকি অংশটুকু এখানে থাকবে)

