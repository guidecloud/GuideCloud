#!/bin/bash
set -euo pipefail

# =============================
# Enhanced Multi-VM Manager (Ryzen 9 Emulated)
# =============================

# Global Variables
VM_DIR="$HOME/vms"
mkdir -p "$VM_DIR"

declare -A OS_OPTIONS=(
    ["Ubuntu 22.04"]="Ubuntu|jammy|https://cloud-images.ubuntu.com/jammy/current/jammy-server-cloudimg-amd64.img|ubuntu-vps|admin|password123"
    ["Debian 12"]="Debian|bookworm|https://cloud.debian.org/images/cloud/bookworm/latest/debian-12-generic-amd64.qcow2|debian-vps|admin|password123"
)

# Function to display header
display_header() {
    clear
    cat << "EOF"
========================================================================
  _    _  ____  _____ _____ _   _  _____ ____   ______     ________
 POWERED BY GUIDECLOUD (RYZEN 9 MODE)
========================================================================
EOF
    echo
}

# Function to display colored output
print_status() {
    local type=$1
    local message=$2
    case $type in
        "INFO") echo -e "\033[1;34m[INFO]\033[0m $message" ;;
        "WARN") echo -e "\033[1;33m[WARN]\033[0m $message" ;;
        "ERROR") echo -e "\033[1;31m[ERROR]\033[0m $message" ;;
        "SUCCESS") echo -e "\033[1;32m[SUCCESS]\033[0m $message" ;;
        "INPUT") echo -e "\033[1;36m[INPUT]\033[0m $message" ;;
    esac
}

# [এখানে আপনার আগের validate_input, check_dependencies, cleanup ফাংশনগুলো থাকবে...]
# সংক্ষেপ করার জন্য মূল পরিবর্তনগুলো নিচে দেওয়া হলো:

# Function to start a VM
start_vm() {
    local vm_name=$1
    
    if load_vm_config "$vm_name"; then
        print_status "INFO" "Starting VM: $vm_name (Emulating Ryzen 9)"
        
        # Base QEMU command with Ryzen 9 Spoofing
        local qemu_cmd=(
            qemu-system-x86_64
            -enable-kvm
            -m "$MEMORY"
            -smp "$CPUS",sockets=1,cores="$CPUS",threads=1
            # --- RYZEN 9 SPOOFING START ---
            -cpu EPYC,vendor=AuthenticAMD,model-id="AMD Ryzen 9 5950X 16-Core Processor",+topoext,+invtsc,+amd-ssbd,+virt-ssbd
            # --- RYZEN 9 SPOOFING END ---
            -drive "file=$IMG_FILE,format=qcow2,if=virtio"
            -drive "file=$SEED_FILE,format=raw,if=virtio"
            -boot order=c
            -device virtio-net-pci,netdev=n0
            -netdev "user,id=n0,hostfwd=tcp::$SSH_PORT-:22"
        )

        # Add port forwards if specified
        if [[ -n "$PORT_FORWARDS" ]]; then
            IFS=',' read -ra forwards <<< "$PORT_FORWARDS"
            for forward in "${forwards[@]}"; do
                IFS=':' read -r host_port guest_port <<< "$forward"
                qemu_cmd+=(-netdev "user,id=forward$host_port,hostfwd=tcp::$host_port-:$guest_port")
            done
        fi

        if [[ "$GUI_MODE" == true ]]; then
            qemu_cmd+=(-vga virtio -display gtk,gl=on)
        else
            qemu_cmd+=(-nographic -serial mon:stdio)
        fi

        qemu_cmd+=(
            -device virtio-balloon-pci
            -object rng-random,filename=/dev/urandom,id=rng0
            -device virtio-rng-pci,rng=rng0
        )

        print_status "SUCCESS" "VM is booting as Ryzen 9. Use 'lscpu' inside VM to check."
        "${qemu_cmd[@]}"
    fi
}

# [বাকি ফাংশনগুলো (create_new_vm, save_vm_config ইত্যাদি) আপনার আগের কোডেই থাকবে]
